<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QRcode widget</title>
    <style>
      @import url("https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css");
      @import url("https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css");
      @import url("https://fonts.googleapis.com/css2?family=Exo+2:wght@200;400;500;600&amp;display=swap");

      /* Configurações gerais */
      body {
        background: transparent;
        font-family: "Exo 2", sans-serif;
        line-height: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Estilos para a caixa de mensagens */
      #widget {
        width: 100%;
        max-width: 200px;
        opacity: 0;
      }

      #widget.close {
        animation: boxClose 1s ease;
        opacity: 0;
      }

      #widget.open {
        animation: boxOpen 1s ease;
        opacity: 1;
      }

      #widget img {
        max-width: 100%;
      }

      #widget .site {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.8rem;
      }

      #widget .messages {
        text-align: center;
        margin: 0.4rem 0 0 0;
      }

      #widget .messages > .show {
        animation: show 1s ease-in;
      }

      #widget .messages > .hide {
        height: 0 !important;
        width: 0 !important;
        overflow: hidden;
        /* animation: hide 0.5s ease-out; */
      }

      /* Animações */
      @keyframes boxClose {
        0% {
          transform: translate3d(0, 0, 0);
        }
        to {
          transform: translate3d(0, -500px, 0);
        }
      }

      @keyframes boxOpen {
        0% {
          transform: translate3d(0, -500px, 0);
        }
        to {
          transform: translate3d(0, 0, 0);
        }
      }

      @keyframes show {
        0% {
          transform: translate3d(0, 10px, 0);
        }
        50% {
          transform: translate3d(0, -10px, 0);
        }
        60% {
          transform: translate3d(0, 0, 0);
        }
      }

      /* @keyframes hide {
        from {
          transform: translate3d(0, 0, 0);
        }
        to {
          transform: translate3d(0, 100px, 0);
        }
      } */
    </style>
  </head>
  <body>
    <div
      id="widget"
      class="close bg-white text-dark rounded-3 p-2 mt-2 overflow-hidden"
    >
      <div class="site"><strong></strong></div>
      <div>
        <img class="qrcode" alt="QRcode" />
      </div>
      <div class="messages"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fitty/2.3.6/fitty.min.js"></script>
    <script>
      // Parametros que definirão os valores do Widget
      const searchParams = new URLSearchParams(location.search);
      const queryParams = Array.from(searchParams.entries()).reduce(
        (params, [key, value]) => ({
          ...params,
          [key.toLowerCase()]: isNaN(value) ? String(value) : Number(value),
        }),
        {}
      );

      // Definição do objeto Widget
      const Widget = {
        // Variável para controlar o índice de mensagens
        idx: 0,

        // Elemento HTML que representa o widget
        boxElement: document.querySelector("#widget"),

        // Lista de mensagens do widget
        messageElements: document.querySelector("#widget .messages"),

        // Variáveis para controlar o intervalo de exibição das mensagens
        messageInterval: null,
        messageIntervalTime: (queryParams.interval || 5) * 1000,

        // Alterna as mensagens exibidas no widget
        messageSlider() {
          const messages = this.messageElements.children;
          const numMessages = messages.length;
          if (this.idx >= numMessages) {
            this.idx = 0;
          }
          for (let i = 0; i < numMessages; i++) {
            const isCurrent = i === this.idx;
            messages[i].classList.toggle("show", isCurrent);
            messages[i].classList.toggle("hide", !isCurrent);
          }
          this.idx++;
        },

        // Variável para controlar o estado atual do widget
        status: "hidden",

        // Exibe o widget
        show() {
          this.boxElement.classList.remove("close");
          this.boxElement.classList.add("open");
          this.status = "shown";
          this.messageInterval = setInterval(
            () => this.messageSlider(),
            this.messageIntervalTime
          );
          this.messageSlider();
        },

        // Oculta o widget
        hide() {
          clearInterval(this.messageInterval);
          this.boxElement.classList.remove("open");
          this.boxElement.classList.add("close");
          this.status = "hidden";
        },

        // Alterna o estado do widget entre exibição e ocultação
        toggle() {
          if (this.status === "shown") {
            this.hide();
            setTimeout(
              () => this.toggle(),
              parseInt(queryParams.hide || 10) * 60000
            );
          } else {
            this.show();
            setTimeout(
              () => this.toggle(),
              parseInt(queryParams.show || 1) * 60000
            );
          }
        },

        // Atualiza a URL exibida no widget
        updateUrl(url) {
          const siteBoxElement = this.boxElement.querySelector(".site strong");
          const qrCodeElement = this.boxElement.querySelector("img.qrcode");
          if (qrCodeElement) {
            qrCodeElement.src = `https://chart.googleapis.com/chart?chs=400x400&cht=qr&chld=L|0&chl=${encodeURIComponent(
              url
            )}`;
          }
          if (siteBoxElement) {
            siteBoxElement.textContent = url.replace(/^https?:\/\//i, "");
            fitty(siteBoxElement, { multiLine: false });
          }
        },

        // Inicializa o widget
        init() {
          const messages = Object.entries(queryParams)
            .filter(([key]) => key.startsWith("msg"))
            .sort()
            .map(([, value]) => value);
          for (let i = 0; i < messages.length; i++) {
            const messageElement = document.createElement("div");
            messageElement.textContent = messages[i];
            this.messageElements.append(messageElement);
            fitty(messageElement);
          }
          this.updateUrl(queryParams.url || "xog.one/pix");
          this.toggle();
        },
      };

      // Inicialização do widget
      onload = () => Widget.init();
    </script>
  </body>
</html>
