<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QRcode widget</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Exo+2:wght@200;400;500;600&display=swap"
    />
    <style>
      /* Configurações gerais */
      body {
        background: transparent;
        /* background-color: aquamarine; */ /* for test */
        font-family: "Exo 2", sans-serif;
        line-height: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Estilos para a caixa de mensagens */
      #widget {
        width: 100%;
        max-width: 200px;
      }

      #widget .site {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.8rem;
      }

      #widget .qrcode {
        max-width: 100%;
        clear: both;
      }

      #widget .messages {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        height: 40px;
      }

      #widget .messages > span {
        position: absolute;
        text-align: center;
      }

      .show {
        opacity: 1;
      }

      .hide {
        opacity: 0;
      }
    </style>
  </head>
  <body>
    <div
      id="widget"
      class="bg-white text-dark rounded-3 p-2 mt-2 overflow-hidden"
    >
      <div class="site"><strong></strong></div>
      <div>
        <img class="qrcode" alt="QRcode" />
      </div>
      <div class="messages"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fitty/2.3.6/fitty.min.js"></script>
    <script>
      // Usaremos animate.css
      const animateCSS = async (element, animation, prefix = "animate__") => {
        const animationName = `${prefix}${animation.replace(prefix, "")}`;
        const node =
          element instanceof Element
            ? element
            : document.querySelector(element);

        node.classList.add(`${prefix}animated`, animationName);

        await new Promise((resolve) =>
          node.addEventListener("animationend", resolve, { once: true })
        );

        node.classList.remove(`${prefix}animated`, animationName);
      };

      // Parametros que definirão os valores do Widget
      const searchParams = new URLSearchParams(location.search);
      const queryParams = Array.from(searchParams.entries()).reduce(
        (params, [key, value]) => ({
          ...params,
          [key.toLowerCase()]: isNaN(value) ? String(value) : Number(value),
        }),
        {}
      );

      // Definição do objeto Widget
      const Widget = {
        // Variável para controlar o índice de mensagens
        idx: 0,

        // Elemento HTML que representa o widget
        boxElement: document.querySelector("#widget"),

        // Lista de mensagens do widget
        messageElements: document.querySelector("#widget .messages"),

        // Variáveis para controlar o intervalo de exibição das mensagens
        messageInterval: null,
        messageIntervalTime: (queryParams.interval || 5) * 1000,

        // Alterna as mensagens exibidas no widget
        messageSlider() {
          const messages = Array.from(this.messageElements.children);
          const numMessages = messages.length;
          const prevIdx = this.idx === 0 ? numMessages - 1 : this.idx - 1;
          messages.forEach((message, index) => {
            const active = this.idx === index;
            const prevMessage = messages[prevIdx];
            const hasPrevMessage = index > 0;
            const isActiveOrPrev = index === prevIdx || active;
            if (active) {
              message.classList.remove("show", "hide");
              animateCSS(message, "bounceInLeft").then(() => {
                message.classList.add("show");
              });
              if (prevMessage) {
                prevMessage.classList.remove("show", "hide");
                animateCSS(prevMessage, "bounceOutRight").then(() =>
                  prevMessage.classList.add("hide")
                );
              }
            } else {
              message.classList.remove("show", "hide");
              if (!isActiveOrPrev) {
                message.classList.add("hide");
              }
            }
          });
          this.idx = (this.idx + 1) % numMessages;
        },

        // Exibe o widget
        show() {
          this.boxElement.classList.remove("hide");
          animateCSS(this.boxElement, "animate__bounceIn").then(() =>
            this.boxElement.classList.add("show")
          );
          this.messageInterval = setInterval(
            () => this.messageSlider(),
            this.messageIntervalTime
          );
          this.messageSlider();
        },

        // Oculta o widget
        hide() {
          clearInterval(this.messageInterval);
          this.idx = 0;
          this.boxElement.classList.remove("show");
          animateCSS(this.boxElement, "animate__bounceOutUp").then(() =>
            this.boxElement.classList.add("hide")
          );
        },

        // Alterna o estado do widget entre exibição e ocultação
        toggle() {
          if (this.boxElement.classList.contains("show")) {
            this.hide();
            setTimeout(() => this.toggle(), (queryParams.hide || 10) * 60000);
          } else {
            this.show();
            setTimeout(() => this.toggle(), (queryParams.show || 1) * 60000);
          }
        },

        // Inicializa o widget
        init() {
          Object.entries(queryParams)
            .filter(([key]) => key.startsWith("msg"))
            .sort()
            .forEach(([, message]) => {
              const messageElement = document.createElement("span");
              messageElement.textContent = message;
              this.messageElements.append(messageElement);
              fitty(messageElement);
            });
          const url = queryParams.url || "xog.one/pix";
          const siteBoxElement = this.boxElement.querySelector(".site strong");
          if (siteBoxElement) {
            siteBoxElement.textContent = url.replace(/^https?:\/\//i, "");
            fitty(siteBoxElement, { multiLine: false });
          }
          const qrCodeElement = this.boxElement.querySelector("img.qrcode");
          if (qrCodeElement) {
            const image = new Image();
            image.src = `https://chart.googleapis.com/chart?chs=400x400&cht=qr&chld=L|0&chl=${encodeURIComponent(
              url
            )}`;
            image.onload = () => {
              qrCodeElement.src = image.src;
              this.toggle();
            };
          }
        },
      };

      // Inicialização do widget
      onload = () => Widget.init();
    </script>
  </body>
</html>
